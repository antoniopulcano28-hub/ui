#!/bin/bash
set -euo pipefail

# ruh.sh
# Usage: ruh.sh [--yes|-y] [--no]
# --yes, -y : auto-answer 'yes' to the prompt (start primary container)
# --no      : auto-answer 'no'  to the prompt (start fallback container)
# -h, --help: show this help

AUTO_YES=false
AUTO_NO=false

print_usage() {
  cat <<EOF
Usage: $0 [options]
Options:
  -y, --yes    Auto-answer 'yes' to the prompt (start primary container)
      --no     Auto-answer 'no' to the prompt (start fallback container)
  -h, --help   Show this help
EOF
}

# Simple option parsing
while [ "$#" -gt 0 ]; do
  case "$1" in
    -y|--yes) AUTO_YES=true; shift ;;
    --no) AUTO_NO=true; shift ;;
    -h|--help) print_usage; exit 0 ;;
    --) shift; break ;;
    -*) printf 'Unknown option: %s\n' "$1" >&2; print_usage; exit 2 ;;
    *) break ;;
  esac
done

if [ "${AUTO_YES}" = true ] && [ "${AUTO_NO}" = true ]; then
  echo "Cannot use --yes and --no together." >&2
  exit 2
fi

# --- Dynamic Configuration ---
# Detect the repository name (e.g., "ui"). Defaults to 'ui' if not found.
REPO_NAME="${RepositoryName:-ui}"

# track first-run flag (avoid unbound variable)
firstrun=false

omitdir() {
    echo "Program is being moved to the /bin directory."
    # copy the running script to /bin/ruh (use $0 so it's robust)
    cp -- "$0" /bin/ruh
    echo "Move complete. To run this program again, type 'ruh' in the terminal. This program will now self destruct in (3) second(s)."
    sleep 3
    # remove the original script file (the one you executed)
    rm -- "$0"
}

# Check for either file "firefox01" or "firefox"
if [ -f "firefox01" ] || [ -f "firefox" ]; then
  echo "Name files exist, exiting."
else
  echo "Name files do not exist, is this the first run?"
  touch firefox01 firefox
fi

sleep 10

# remove matching containers (force). silence errors.
docker rm -f firefox* 2>/dev/null || true

if [ "$PWD" = "/bin" ]; then
  echo "You are in /bin"
else
  echo "Not in /bin. This script is better run from /bin."
  firstrun=true
fi

# Settings for the primary container
DEFAULT_NAME="firefox"
DEFAULT_PORT="5800"
DEFAULT_CONFIG_PATH="/workspaces/${REPO_NAME}/fox"

# Settings for the fallback (second) container
FALLBACK_NAME="firefox01"
FALLBACK_PORT="5801"
FALLBACK_CONFIG_PATH="/workspaces/${REPO_NAME}/fox2"

# --- Interactive User Prompt ---
if [ "${AUTO_YES}" = true ]; then
  REPLY="y"
  echo "Auto-answer: yes"
elif [ "${AUTO_NO}" = true ]; then
  REPLY="n"
  echo "Auto-answer: no"
else
  read -r -p "Do you want to start the primary '${DEFAULT_NAME}' container? (y/n): " -n 1 -r
  echo
fi

# --- Script Logic ---
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "You chose to start the primary container: '${DEFAULT_NAME}'"
    CONTAINER_TO_CREATE_NAME="$DEFAULT_NAME"
    PORT_TO_USE="$DEFAULT_PORT"
    CONFIG_PATH_TO_USE="$DEFAULT_CONFIG_PATH"

    if docker ps -a --format '{{.Names}}' | grep -q -w "^${DEFAULT_NAME}$"; then
        echo "Error: Container '${DEFAULT_NAME}' already exists."
        exit 1
    fi

elif [[ $REPLY =~ ^[Nn]$ ]]; then
    echo "You chose to start the secondary container: '${FALLBACK_NAME}'"
    CONTAINER_TO_CREATE_NAME="$FALLBACK_NAME"
    PORT_TO_USE="$FALLBACK_PORT"
    CONFIG_PATH_TO_USE="$FALLBACK_CONFIG_PATH"

    if docker ps -a --format '{{.Names}}' | grep -q -w "^${FALLBACK_NAME}$"; then
        echo "Error: Container '${FALLBACK_NAME}' already exists."
        exit 1
    fi
else
    echo "Invalid choice."
    exit 1
fi

echo "---"
echo "Detected Repo Path: /workspaces/${REPO_NAME}"
echo "Config Path:        ${CONFIG_PATH_TO_USE}"
echo "---"

# Create the host directory
mkdir -p -- "${CONFIG_PATH_TO_USE}"

# Run the docker container
docker run -d \
    --name="${CONTAINER_TO_CREATE_NAME}" \
    -p "${PORT_TO_USE}:5800" \
    -v "${CONFIG_PATH_TO_USE}:/config:rw" \
    -e DARK_MODE=1 \
    -e WEB_AUDIO=1 \
    -e SECURE_CONNECTION=0 \
    -e ENABLE_CJK_FONT=1 \
    jlesage/firefox

echo "---"
echo "Successfully launched container '${CONTAINER_TO_CREATE_NAME}'."

if [ "$firstrun" = true ]; then
  omitdir
fi
